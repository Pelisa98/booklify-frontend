<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Booklify</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/analytics.css">
    <link rel="icon" href="/frontend/assets/icons/booklify.ico">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header / Navbar (dynamically generated by navbar.js) -->

    <!-- Admin Dashboard -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="overviewNav"><i class="bi bi-house-door"></i> Overview</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="usersNav"><i class="bi bi-people"></i> Users</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="booksNav"><i class="bi bi-book"></i> Books</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="ordersNav"><i class="bi bi-cart"></i> Orders</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="analyticsNav"><i class="bi bi-graph-up"></i> Analytics</a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link" href="admin-profile.html" id="profileNav"><i class="bi bi-person-badge"></i> Profile</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                </div>

                <!-- Overview Section -->
                <div id="overviewSection">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card"><div class="card-body"><h5 class="card-title">Total Users</h5><p class="card-text display-6" id="totalUsersCount">0</p></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card"><div class="card-body"><h5 class="card-title">Total Books</h5><p class="card-text display-6" id="totalBooksCount">0</p></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card"><div class="card-body"><h5 class="card-title">Total Orders</h5><p class="card-text display-6" id="totalOrdersCount">0</p></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card"><div class="card-body"><h5 class="card-title">Total Revenue</h5><p class="card-text display-6" id="totalRevenue">R0.00</p></div></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Recent Activities</h5>
                            <button class="btn btn-sm btn-outline-purple" onclick="loadActivities()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 25%;">Action</th>
                                            <th style="width: 25%;">User</th>
                                            <th style="width: 35%;">Details</th>
                                            <th style="width: 15%;">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activitiesTableBody">
                                        <tr><td colspan="4" class="text-center">Loading activities...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- User Management Section -->
                <div id="userManagementSection" style="display: none;"><div class="card"><div class="card-header"><h5 class="card-title mb-0">User Management</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Date Joined</th><th>Actions</th></tr></thead><tbody id="usersTableBody"></tbody></table></div></div></div></div>

                <!-- Book Management Section -->
                                <div id="bookManagementSection" style="display: none;">
                                    <div class="card">
                                        <div class="card-header"><h5 class="card-title mb-0">Book Management</h5></div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle" style="table-layout: fixed; width: 100%;">
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 6%;">Book ID</th>
                                                            <th style="width: 22%;">Title</th>
                                                            <th style="width: 15%;">Author</th>
                                                            <th style="width: 10%;">Price</th>
                                                            <th style="width: 17%;">Uploaded By</th>
                                                            <th style="width: 10%;">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="booksTableBody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                
                <!-- Order Management Section -->
                <div id="orderManagementSection" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Order Management</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-purple me-2" onclick="loadUnifiedOrders()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <select class="form-select form-select-sm d-inline-block w-auto" id="statusFilter" onchange="filterOrdersByStatus()">
                                    <option value="">All Statuses</option>
                                    <option value="PENDING">Pending</option>
                                    <option value="PROCESSING">Processing</option>
                                    <option value="SHIPPED">Shipped</option>
                                    <option value="DELIVERED">Delivered</option>
                                    <option value="CANCELLED">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th style="width: 7%;">Order ID</th>
                                            <th style="width: 15%;">Customer</th>
                                            <th style="width: 20%;">Book Title</th>
                                            <th style="width: 6%;">Qty</th>
                                            <th style="width: 10%;">Amount</th>
                                            <th style="width: 10%;">Status</th>
                                            <th style="width: 20%;">Shipping Address</th>
                                            <th style="width: 12%;">Order Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="unifiedOrdersTableBody">
                                        <tr><td colspan="8" class="text-center">Loading orders...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analyticsSection" style="display: none;">
                    <div class="analytics-header d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1"><i class="bi bi-graph-up me-2"></i>Analytics Dashboard</h4>
                            <p class="mb-0 opacity-75">Comprehensive insights and statistics for your platform</p>
                        </div>
                        <button class="btn btn-light btn-sm" onclick="refreshAnalytics()" id="refreshAnalyticsBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
                        </button>
                    </div>
                    <!-- Analytics content will be dynamically inserted here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modals (User and Book) -->
    <div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="editUserId"><div class="mb-3"><label for="editFullName" class="form-label">Full Name</label><input type="text" class="form-control" id="editFullName"></div><div class="mb-3"><label for="editEmail" class="form-label">Email</label><input type="email" class="form-control" id="editEmail"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="saveUserChanges">Save Changes</button></div></div></div></div>
    <div class="modal fade" id="editBookModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Book</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="editBookId"><div class="mb-3"><label for="editBookTitle" class="form-label">Title</label><input type="text" class="form-control" id="editBookTitle"></div><div class="mb-3"><label for="editBookAuthor" class="form-label">Author</label><input type="text" class="form-control" id="editBookAuthor"></div><div class="mb-3"><label for="editBookIsbn" class="form-label">ISBN</label><input type="text" class="form-control" id="editBookIsbn"></div><div class="mb-3"><label for="editBookPrice" class="form-label">Price</label><input type="number" class="form-control" id="editBookPrice"></div><div class="mb-3"><label for="editBookDescription" class="form-label">Description</label><textarea class="form-control" id="editBookDescription" rows="3"></textarea></div><div class="mb-3"><label for="editBookCondition" class="form-label">Condition</label><select class="form-select" id="editBookCondition"><option>EXCELLENT</option><option>GOOD</option><option>FAIR</option></select></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="saveBookChanges">Save changes</button></div></div></div></div>

    <!-- Notification Modals -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-exclamation-triangle-fill text-warning fs-2"></i>
                        </div>
                        <div>
                            <p id="confirmMessage" class="mb-0">Are you sure you want to perform this action?</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="modal-title mb-2" id="successModalLabel">Success!</h5>
                    <p id="successMessage" class="text-muted mb-0">Operation completed successfully.</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="modal-title mb-2" id="errorModalLabel">Error</h5>
                    <p id="errorMessage" class="text-muted mb-0">An error occurred. Please try again.</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="toastContainer"></div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-purple text-white">
                    <h5 class="modal-title" id="logoutModalLabel">
                        <i class="bi bi-box-arrow-right me-2"></i>Confirm Logout
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-question-circle-fill text-purple me-3" style="font-size: 2rem;"></i>
                        <div>
                            <p class="mb-1 fw-bold">Are you sure you want to logout?</p>
                            <p class="mb-0 text-muted">You will be redirected to the login page and will need to sign in again.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-purple" id="confirmLogoutBtn">
                        <i class="bi bi-box-arrow-right me-1"></i>Yes, Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/adminService.js"></script>
    <script src="../js/reviewService.js"></script>
    <script type="module" src="../js/navbar.js"></script>
    
    <!-- Analytics JavaScript Files -->
    <script src="../js/chartService.js"></script>
    <script src="../js/adminAnalytics.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- AUTH CHECK ---
        const token = localStorage.getItem('booklifyToken');
        const userRole = localStorage.getItem('booklifyUserRole');
        
        console.log('Admin Dashboard - Auth check:');
        console.log('Token available:', !!token);
        console.log('User role:', userRole);
        
        if (userRole !== 'admin') {
            console.error('User is not an admin. Redirecting to login...');
            window.location.href = 'adminLogIn.html';
            return;
        }
        
        if (!token) {
            console.error('No authentication token found. Redirecting to login...');
            window.location.href = 'adminLogIn.html';
            return;
        }
        
        console.log('Authentication successful. Loading admin dashboard...');
        
        // Check if AdminService is available
        if (typeof AdminService === 'undefined') {
            console.error('AdminService is not loaded! Check if adminService.js is included correctly.');
            return;
        }
        
        console.log('AdminService loaded successfully');
        
        // Clean old activities to ensure we only show recent ones
        if (typeof AdminService.cleanOldActivities === 'function') {
            AdminService.cleanOldActivities();
        }

        // --- HELPERS ---
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-ZA') : 'N/A';
        const formatCurrency = (n) => `R${(n || 0).toFixed(2)}`;
        
        // New helper to format date and time for activities
        const formatDateTime = (dateStr) => {
            if (!dateStr) return 'N/A';
            
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            // Show relative time for recent activities
            if (diffMs < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diffMins < 60) { // Less than 1 hour
                return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) { // Less than 1 day
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) { // Less than 1 week
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            } else {
                // Show actual date and time for older activities
                return date.toLocaleString('en-ZA', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        };

        // --- NOTIFICATION SYSTEM ---
        const showSuccessModal = (message, title = 'Success!') => {
            document.getElementById('successModalLabel').textContent = title;
            document.getElementById('successMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        };

        const showErrorModal = (message, title = 'Error') => {
            document.getElementById('errorModalLabel').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        };

        const showConfirmModal = (message, onConfirm, title = 'Confirm Action') => {
            document.getElementById('confirmModalLabel').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            
            // Remove any existing event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            // Add new event listener
            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                modal.hide();
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });
            
            modal.show();
        };

        const showToast = (message, type = 'success', duration = 3000) => {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastTypes = {
                success: { class: 'bg-success', icon: 'bi-check-circle-fill' },
                error: { class: 'bg-danger', icon: 'bi-x-circle-fill' },
                warning: { class: 'bg-warning', icon: 'bi-exclamation-triangle-fill' },
                info: { class: 'bg-info', icon: 'bi-info-circle-fill' }
            };
            
            const toastType = toastTypes[type] || toastTypes.success;
            
            const toastHtml = `
                <div id="${toastId}" class="toast text-white ${toastType.class}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-body d-flex align-items-center">
                        <i class="bi ${toastType.icon} me-2"></i>
                        <span class="flex-grow-1">${message}</span>
                        <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        };

        // --- NAVIGATION ---
        const sections = ['overviewSection', 'userManagementSection', 'bookManagementSection', 'orderManagementSection', 'analyticsSection'];
        const navLinks = document.querySelectorAll('#sidebarMenu .nav-link');
        const navMap = { overviewNav: 'overviewSection', usersNav: 'userManagementSection', booksNav: 'bookManagementSection', ordersNav: 'orderManagementSection', analyticsNav: 'analyticsSection' };
        const showSection = (targetId) => {
            sections.forEach(id => document.getElementById(id).style.display = (id === targetId) ? 'block' : 'none');
            navLinks.forEach(link => link.classList.toggle('active', navMap[link.id] === targetId));
        };
        navLinks.forEach(link => link.addEventListener('click', (e) => {
            // Only prevent default and switch section for dashboard sections
            if (navMap[e.currentTarget.id]) {
                e.preventDefault();
                showSection(navMap[e.currentTarget.id]);
                
                // Initialize analytics when analytics section is shown
                if (e.currentTarget.id === 'analyticsNav') {
                    initializeAnalytics();
                }
            }
            // For profileNav, allow normal navigation
        }));

        // --- MODALS ---
        const userModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        const bookModal = new bootstrap.Modal(document.getElementById('editBookModal'));

        // --- DATA LOADERS ---
        const loadUsers = async () => {
            try {
                const users = await AdminService.getAllUsers();
                document.getElementById('usersTableBody').innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.fullName}</td>
                        <td>${user.email}</td>
                        <td>${formatDate(user.dateJoined || user.createdAt)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`).join('');
                document.getElementById('totalUsersCount').textContent = users.length;
            } catch (e) { 
                console.error("Failed to load users:", e); 
                console.error("Error details:", e.message);
                // Show error in the UI
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load users. Check console for details.</td></tr>';
            }
        };

        const loadBooks = async () => {
            try {
                const books = await AdminService.getAllBooks();
                const tbody = document.getElementById('booksTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                for (const book of books) {
                    let uploaderDisplay = 'N/A';
                    if (book.uploader) {
                        uploaderDisplay = `${book.uploader.fullName || ''}<br><small>${book.uploader.email || ''}</small>`;
                    } else if (book.userId && book.uploaderName && book.uploaderEmail) {
                        uploaderDisplay = `${book.uploaderName}<br><small>${book.uploaderEmail}</small>`;
                    } else if (book.userId) {
                        uploaderDisplay = book.userId;
                    }
                    tbody.innerHTML += `
                        <tr>
                            <td style="word-break: break-all;">${book.bookID || book.id}</td>
                            <td style="word-break: break-word; white-space: normal;">${book.title}</td>
                            <td style="word-break: break-word; white-space: normal;">${book.author}</td>
                            <td style="word-break: break-all;">${formatCurrency(book.price)}</td>
                            <td style="word-break: break-word; white-space: normal;">${uploaderDisplay}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editBook(${book.bookID || book.id})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBook(${book.bookID || book.id})"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>`;
                }
                document.getElementById('totalBooksCount').textContent = books.length;
            } catch (e) { 
                console.error("Failed to load books:", e); 
                console.error("Error details:", e.message);
                // Show error in the UI
                document.getElementById('booksTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load books. Check console for details.</td></tr>';
            }
        };

        // Global variable to store all order data for filtering
        let allUnifiedOrders = [];

        const loadUnifiedOrders = async () => {
            try {
                console.log('Loading unified orders...');
                
                // Get both orders and order items
                const [orders, orderItems] = await Promise.all([
                    AdminService.viewAllOrders(),
                    AdminService.viewAllOrderItems()
                ]);
                
                console.log('Orders loaded:', orders.length);
                console.log('Order items loaded:', orderItems.length);
                
                // Debug: Log first order to see address structure
                if (orders.length > 0) {
                    console.log('Sample order data:', orders[0]);
                    if (orders[0].regularUser) {
                        console.log('Sample user data:', orders[0].regularUser);
                    }
                }
                
                // Create a unified structure by combining orders with their items
                const unifiedData = [];
                
                orderItems.forEach(item => {
                    // Find the matching order
                    const order = orders.find(o => o.orderId === item.orderId);
                    
                    let customer = 'Unknown User';
                    let orderDate = 'N/A';
                    let shippingAddress = 'No address provided';
                    
                    if (order && order.regularUser) {
                        customer = order.regularUser.fullName || order.regularUser.email || 'Unknown User';
                        orderDate = order.orderDate || order.createdAt;
                        
                        // Function to extract address from object or string
                        const extractAddress = (addressData) => {
                            if (!addressData) return null;
                            
                            // If it's already a string, return it
                            if (typeof addressData === 'string') {
                                return addressData;
                            }
                            
                            // If it's an object, try to construct address from its properties
                            if (typeof addressData === 'object') {
                                const parts = [];
                                
                                // Common address field names to check
                                const fields = ['street', 'streetAddress', 'address1', 'line1'];
                                const cityFields = ['city', 'town'];
                                const stateFields = ['state', 'province', 'region'];
                                const zipFields = ['zipCode', 'postalCode', 'zip'];
                                
                                // Get street
                                for (const field of fields) {
                                    if (addressData[field]) {
                                        parts.push(addressData[field]);
                                        break;
                                    }
                                }
                                
                                // Get city
                                for (const field of cityFields) {
                                    if (addressData[field]) {
                                        parts.push(addressData[field]);
                                        break;
                                    }
                                }
                                
                                // Get state/province
                                for (const field of stateFields) {
                                    if (addressData[field]) {
                                        parts.push(addressData[field]);
                                        break;
                                    }
                                }
                                
                                // Get postal code
                                for (const field of zipFields) {
                                    if (addressData[field]) {
                                        parts.push(addressData[field]);
                                        break;
                                    }
                                }
                                
                                return parts.length > 0 ? parts.join(', ') : null;
                            }
                            
                            return null;
                        };
                        
                        // Try different address sources in order of preference
                        let extractedAddress = null;
                        
                        // 1. Order shipping address
                        if (order.shippingAddress) {
                            extractedAddress = extractAddress(order.shippingAddress);
                        }
                        
                        // 2. Order address
                        if (!extractedAddress && order.address) {
                            extractedAddress = extractAddress(order.address);
                        }
                        
                        // 3. User address
                        if (!extractedAddress && order.regularUser.address) {
                            extractedAddress = extractAddress(order.regularUser.address);
                        }
                        
                        // 4. Try individual fields from order
                        if (!extractedAddress) {
                            const orderParts = [];
                            if (order.street) orderParts.push(order.street);
                            if (order.city) orderParts.push(order.city);
                            if (order.province) orderParts.push(order.province);
                            if (order.postalCode) orderParts.push(order.postalCode);
                            
                            if (orderParts.length > 0) {
                                extractedAddress = orderParts.join(', ');
                            }
                        }
                        
                        // 5. Try individual fields from user
                        if (!extractedAddress) {
                            const userParts = [];
                            if (order.regularUser.street) userParts.push(order.regularUser.street);
                            if (order.regularUser.city) userParts.push(order.regularUser.city);
                            if (order.regularUser.province) userParts.push(order.regularUser.province);
                            if (order.regularUser.postalCode) userParts.push(order.regularUser.postalCode);
                            
                            if (userParts.length > 0) {
                                extractedAddress = userParts.join(', ');
                            }
                        }
                        
                        if (extractedAddress) {
                            shippingAddress = extractedAddress;
                        }
                    }
                    
                    unifiedData.push({
                        orderItemId: item.orderItemId,
                        orderId: item.orderId || 'N/A',
                        customer: customer,
                        bookTitle: item.bookTitle || 'N/A',
                        quantity: item.quantity ?? 'N/A',
                        totalAmount: item.totalAmount,
                        status: item.orderStatus || item.status || 'PENDING',
                        orderDate: orderDate,
                        shippingAddress: shippingAddress
                    });
                });
                
                // Sort by order ID descending (newest first)
                unifiedData.sort((a, b) => {
                    const orderIdA = parseInt(a.orderId) || 0;
                    const orderIdB = parseInt(b.orderId) || 0;
                    return orderIdB - orderIdA;
                });
                
                // Store for filtering
                allUnifiedOrders = unifiedData;
                
                // Update total orders count (unique orders)
                const uniqueOrderIds = [...new Set(unifiedData.map(item => item.orderId))];
                document.getElementById('totalOrdersCount').textContent = uniqueOrderIds.length;
                
                // Render the table
                renderUnifiedOrdersTable(unifiedData);
                
            } catch (e) { 
                console.error("Failed to load unified orders:", e); 
                console.error("Error details:", e.message);
                // Show error in the UI
                document.getElementById('unifiedOrdersTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load orders. Check console for details.</td></tr>';
            }
        };

        const renderUnifiedOrdersTable = (data) => {
            const statuses = ['PENDING', 'PROCESSING', 'SHIPPED', 'DELIVERED', 'CANCELLED'];
            
            document.getElementById('unifiedOrdersTableBody').innerHTML = data.map(item => {
                const statusClass = getStatusClass(item.status);
                const options = statuses.map(s => `<option value="${s}" ${item.status === s ? 'selected' : ''}>${s}</option>`).join('');
                
                return `
                    <tr>
                        <td><strong>${item.orderId}</strong></td>
                        <td>${item.customer}</td>
                        <td class="text-truncate" style="max-width: 180px;" title="${item.bookTitle}">${item.bookTitle}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.totalAmount)}</td>
                        <td>
                            <select class="form-select form-select-sm ${statusClass}" onchange="updateOrderItemStatus(${item.orderItemId}, this.value)">
                                ${options}
                            </select>
                        </td>
                        <td class="text-truncate" style="max-width: 200px;" title="${item.shippingAddress}">
                            <small>${item.shippingAddress}</small>
                        </td>
                        <td class="small">${formatDate(item.orderDate)}</td>
                    </tr>`;
            }).join('');
        };

        const getStatusClass = (status) => {
            switch (status?.toLowerCase()) {
                case 'delivered': return 'text-bg-success';
                case 'shipped': return 'text-bg-info';
                case 'processing': return 'text-bg-warning';
                case 'cancelled': return 'text-bg-danger';
                default: return 'text-bg-secondary';
            }
        };

        // Function to filter orders by status
        window.filterOrdersByStatus = () => {
            const selectedStatus = document.getElementById('statusFilter').value;
            
            if (!selectedStatus) {
                // Show all orders
                renderUnifiedOrdersTable(allUnifiedOrders);
            } else {
                // Filter by selected status
                const filteredData = allUnifiedOrders.filter(item => 
                    item.status.toUpperCase() === selectedStatus.toUpperCase()
                );
                renderUnifiedOrdersTable(filteredData);
            }
        };

        const loadRevenue = async () => {
            try {
                const revenue = await AdminService.calculateTotalRevenue();
                document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
            } catch (e) { console.error("Failed to load revenue:", e); document.getElementById('totalRevenue').textContent = 'Error'; }
        };

        const loadActivities = async () => {
            try {
                console.log('Loading recent activities...');
                
                // Show loading state
                const activitiesTableBody = document.getElementById('activitiesTableBody');
                activitiesTableBody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="bi bi-arrow-clockwise fa-spin me-2"></i>Loading activities...</td></tr>';
                
                // Use enhanced method that combines API and stored activities
                console.log('Calling AdminService.getRecentActivitiesEnhanced...');
                const activities = await AdminService.getRecentActivitiesEnhanced(8);
                console.log('Activities loaded:', activities?.length || 0, activities);
                
                if (!activities || activities.length === 0) {
                    activitiesTableBody.innerHTML = `
                        <tr><td colspan="4" class="text-center text-muted">
                            <i class="bi bi-info-circle me-2"></i>
                            No recent activities found. Activities will appear as you use the system.
                        </td></tr>`;
                } else {
                    activitiesTableBody.innerHTML = activities.map(activity => `
                        <tr>
                            <td>
                                <i class="${activity.icon} me-2 text-primary"></i>
                                <span class="fw-medium">${activity.action}</span>
                            </td>
                            <td>
                                <span class="text-secondary">${activity.user || 'Unknown User'}</span>
                            </td>
                            <td>
                                <span class="text-dark">${activity.details || 'No details available'}</span>
                            </td>
                            <td>
                                <small class="text-muted">${formatDateTime(activity.date)}</small>
                            </td>
                        </tr>
                    `).join('');
                }
                
                console.log('Activities table updated successfully');
            } catch (e) { 
                console.error("Failed to load activities:", e); 
                console.error("Error details:", e.message);
                
                // Show detailed error information
                document.getElementById('activitiesTableBody').innerHTML = `
                    <tr><td colspan="4" class="text-center">
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Unable to load activities</strong><br>
                            <small>Error: ${e.message || 'Unknown error occurred'}</small><br>
                            <button class="btn btn-sm btn-outline-warning mt-2" onclick="loadActivities()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Try Again
                            </button>
                        </div>
                    </td></tr>`;
            }
        };

        // Auto-refresh activities every 2 minutes
        setInterval(loadActivities, 120000);

        // Make functions globally accessible
        window.loadUnifiedOrders = loadUnifiedOrders;
        window.loadActivities = loadActivities;

        // --- GLOBAL ACTIONS ---
        window.editUser = async (id) => {
            // Check authentication first
            if (!AdminService.checkAuthAndRedirect()) {
                return;
            }

            try {
                const user = await AdminService.getUserById(id);
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFullName').value = user.fullName;
                document.getElementById('editEmail').value = user.email;
                userModal.show();
            } catch (e) { 
                if (e.message.includes('forbidden') || e.message.includes('Authentication')) {
                    AdminService.checkAuthAndRedirect();
                } else {
                    showErrorModal('Failed to fetch user details: ' + e.message);
                }
            }
        };

        window.deleteUser = async (id) => {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try { 
                    // Get user details for logging before deletion
                    let userDetails = 'Unknown User';
                    try {
                        const user = await AdminService.getUserById(id);
                        userDetails = user.fullName || user.email || `User ID: ${id}`;
                    } catch (e) {
                        console.warn('Could not fetch user details for logging:', e);
                    }
                    
                    await AdminService.deleteUser(id); 
                    
                    // Log activity
                    AdminService.logActivity(
                        'User Deleted', 
                        'Admin', 
                        `Deleted user: ${userDetails}`, 
                        'user_delete'
                    );
                    
                    await loadUsers(); 
                    showSuccessModal('User deleted successfully');
                } 
                catch (e) { 
                    showErrorModal('Failed to delete user: ' + e.message); 
                }
            }
        };

        window.editBook = async (id) => {
            try {
                const book = await AdminService.getBookById(id);
                document.getElementById('editBookId').value = book.id;
                document.getElementById('editBookTitle').value = book.title;
                document.getElementById('editBookAuthor').value = book.author;
                document.getElementById('editBookIsbn').value = book.isbn;
                document.getElementById('editBookPrice').value = book.price;
                document.getElementById('editBookDescription').value = book.description;
                document.getElementById('editBookCondition').value = book.condition;
                bookModal.show();
            } catch (e) { showErrorModal('Failed to fetch book details: ' + e.message); }
        };

        window.deleteBook = async (id) => {
            showConfirmModal('Are you sure you want to delete this book? This action cannot be undone.', async () => {
                try { 
                    // Get book details for logging before deletion
                    let bookDetails = 'Unknown Book';
                    try {
                        const book = await AdminService.getBookById(id);
                        bookDetails = `"${book.title}" by ${book.author}`;
                    } catch (e) {
                        console.warn('Could not fetch book details for logging:', e);
                        bookDetails = `Book ID: ${id}`;
                    }
                    
                    await AdminService.deleteBookById(id); 
                    
                    // Log activity
                    AdminService.logActivity(
                        'Book Deleted', 
                        'Admin', 
                        `Deleted book: ${bookDetails}`, 
                        'book_delete'
                    );
                    
                    await loadBooks();
                    showSuccessModal('Book deleted successfully');
                } 
                catch (e) { 
                    showErrorModal('Failed to delete book: ' + e.message); 
                }
            }, 'Delete Book');
        };

        window.updateOrderItemStatus = async (id, status) => {
            if (!AdminService.checkAuthAndRedirect()) {
                return;
            }

            try {
                await AdminService.updateOrderItemStatus(id, status);
                
                // Log activity
                AdminService.logActivity(
                    'Status Update', 
                    'Admin', 
                    `Order item #${id} status changed to ${status}`, 
                    'status_update'
                );
                
                showToast('Order status updated successfully');
                await loadUnifiedOrders();
            } catch (e) {
                if (e.message.includes('forbidden') || e.message.includes('Authentication')) {
                    AdminService.checkAuthAndRedirect();
                } else {
                    showErrorModal('Failed to update status: ' + e.message);
                    await loadUnifiedOrders();
                }
            }
        };

        // --- FORM SUBMISSIONS ---
        document.getElementById('saveUserChanges').addEventListener('click', async () => {
            const id = document.getElementById('editUserId').value;
            const data = { fullName: document.getElementById('editFullName').value, email: document.getElementById('editEmail').value };
            try { 
                await AdminService.updateUser(id, data); 
                
                // Log activity
                AdminService.logActivity(
                    'User Updated', 
                    'Admin', 
                    `Updated user: ${data.fullName || data.email}`, 
                    'user_edit'
                );
                
                userModal.hide(); 
                await loadUsers();
                showSuccessModal('User updated successfully');
            } 
            catch (e) { 
                showErrorModal('Failed to update user: ' + e.message); 
            }
        });

        document.getElementById('saveBookChanges').addEventListener('click', async () => {
            const id = document.getElementById('editBookId').value;
            const data = { title: document.getElementById('editBookTitle').value, author: document.getElementById('editBookAuthor').value, isbn: document.getElementById('editBookIsbn').value, price: document.getElementById('editBookPrice').value, description: document.getElementById('editBookDescription').value, condition: document.getElementById('editBookCondition').value };
            try { 
                await AdminService.updateBookById(id, data); 
                
                // Log activity
                AdminService.logActivity(
                    'Book Updated', 
                    'Admin', 
                    `Updated book: "${data.title}" by ${data.author}`, 
                    'book_edit'
                );
                
                bookModal.hide(); 
                await loadBooks();
                showSuccessModal('Book updated successfully');
            } 
            catch (e) { 
                showErrorModal('Failed to update book: ' + e.message); 
            }
        });
        
        // Handle confirmed logout from modal (navbar.js handles the logout button click)
        document.getElementById('confirmLogoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Log the logout activity
            try {
                const userEmail = localStorage.getItem('booklifyUserEmail') || 'Unknown Admin';
                if (typeof AdminService.logActivity === 'function') {
                    AdminService.logActivity('Admin Logout', userEmail, 'Administrator logged out from dashboard', 'admin_logout');
                }
            } catch (error) {
                console.warn('Could not log logout activity:', error);
            }
            
            // Clear all session data
            localStorage.clear();
            
            // Redirect to login page
            window.location.href = 'adminLogIn.html';
        });

        // --- INITIAL LOAD ---
        showSection('overviewSection');
        
        // Log initial activity with error handling
        try {
            if (typeof AdminService !== 'undefined' && AdminService.logActivity) {
                AdminService.logActivity(
                    'Dashboard Access', 
                    'Admin', 
                    'Admin dashboard accessed and loaded successfully', 
                    'system'
                );
                console.log('Initial dashboard activity logged');
            } else {
                console.warn('AdminService.logActivity not available');
            }
        } catch (error) {
            console.error('Error logging initial activity:', error);
        }
        
        Promise.all([loadUsers(), loadBooks(), loadUnifiedOrders(), loadRevenue(), loadActivities()]);
    });

    // --- DEBUG FUNCTIONS ---
    function debugAnalytics() {
        console.log('=== ANALYTICS DEBUG INFO ===');
        console.log('Chart.js loaded:', typeof Chart !== 'undefined');
        console.log('AdminAnalytics loaded:', typeof AdminAnalytics !== 'undefined');
        console.log('ChartService loaded:', typeof ChartService !== 'undefined');
        console.log('AdminService loaded:', typeof AdminService !== 'undefined');
        console.log('Toggle button exists:', !!document.getElementById('analyticsToggle'));
        console.log('Analytics section exists:', !!document.getElementById('analyticsSection'));
        console.log('========================');
    }

    // --- ANALYTICS INITIALIZATION FUNCTION ---
    function initializeAnalytics() {
        console.log('Initializing analytics dashboard...');
        
        const analyticsSection = document.getElementById('analyticsSection');
        
        // Only initialize if not already done
        if (!window.adminAnalytics) {
            if (typeof AdminAnalytics !== 'undefined') {
                console.log('Creating AdminAnalytics instance...');
                try {
                    window.adminAnalytics = new AdminAnalytics();
                    console.log('Analytics dashboard initialized successfully');
                } catch (error) {
                    console.error('Error initializing analytics:', error);
                    analyticsSection.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Error Loading Analytics:</strong> ${error.message}
                            <br><small>Please refresh the page and try again.</small>
                        </div>
                    `;
                }
            } else {
                console.error('AdminAnalytics class not found. Make sure adminAnalytics.js is loaded.');
                analyticsSection.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Analytics Unavailable:</strong> The analytics system is not loaded.
                        <br><small>Please refresh the page and try again.</small>
                    </div>
                `;
            }
        } else {
            console.log('Analytics already initialized, refreshing data...');
            if (typeof window.adminAnalytics.refreshAnalytics === 'function') {
                window.adminAnalytics.refreshAnalytics();
            }
        }
    }

    // Function to refresh analytics (called by AdminAnalytics)
    window.refreshAdminAnalytics = function() {
        if (window.adminAnalytics && typeof window.adminAnalytics.refreshAnalytics === 'function') {
            window.adminAnalytics.refreshAnalytics();
        }
    };

    // Function to refresh analytics (called by refresh button)
    window.refreshAnalytics = function() {
        console.log('Refreshing analytics data...');
        if (window.adminAnalytics && typeof window.adminAnalytics.refreshAnalytics === 'function') {
            window.adminAnalytics.refreshAnalytics();
        } else if (typeof refreshAdminAnalytics === 'function') {
            refreshAdminAnalytics();
        } else {
            console.error('No analytics instance found to refresh');
            alert('Analytics not initialized yet. Please show the charts first.');
        }
    };
    </script>
</body>
</html>