<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell Your Book | Booklify</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/frontend/assets/icons/booklify.ico">
    <style>
        .lilac-alert {
            background-color: #8a2be2; /* Lilac color */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-top: 15px;
        }
        
        .lilac-alert.error {
            background-color: #dc3545; /* Red for errors */
        }
        
        .lilac-alert.success {
            background-color: #8a2be2; /* Lilac for success */
        }
        
        .alert-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
        }
        
        .form-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: block;
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
        }
        
        .btn-purple {
            background-color: #8a2be2;
            border-color: #8a2be2;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #7b1fa2;
            border-color: #7b1fa2;
        }
        
        .bg-light-purple {
            background-color: #f5f0ff;
        }
        
        .text-purple {
            color: #8a2be2;
        }
    </style>
</head>
<body>
<!-- Header / Navbar (dynamically generated by navbar.js) -->

<!-- Sell Book Form Section -->
<section class="sell-section py-5 bg-light-purple min-vh-100">
    <div class="container">
        <h2 class="fw-bold text-center mb-4">Sell Your Textbook</h2>
        <div class="row justify-content-center">
            <div class="col-lg-7">
                <div class="bg-white rounded shadow p-4">
                    <form id="sellForm">
                        <!-- Book Details -->
                        <h5 class="mb-3 text-purple">Book Information</h5>
                        <div class="mb-3">
                            <label for="bookTitle" class="form-label">Book Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bookTitle" placeholder="Enter book title" required>
                            <span class="form-error" id="bookTitleError"></span>
                        </div>
                        <div class="mb-3">
                            <label for="bookAuthor" class="form-label">Author <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bookAuthor" placeholder="Enter author name" required>
                            <span class="form-error" id="bookAuthorError"></span>
                        </div>
                        <div class="mb-3">
                            <label for="bookPublisher" class="form-label">Publisher</label>
                            <input type="text" class="form-control" id="bookPublisher" placeholder="Enter publisher name">
                        </div>
                        <div class="mb-3">
                            <label for="bookISBN" class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="bookISBN" placeholder="Enter ISBN number">
                        </div>

                        <!-- Listing Details -->
                        <h5 class="mb-3 mt-4 text-purple">Listing Details</h5>
                        <div class="mb-3">
                            <label for="bookCondition" class="form-label">Condition <span class="text-danger">*</span></label>
                            <select class="form-select" id="bookCondition" required>
                                <option value="">Select condition</option>
                                <option value="EXCELLENT">EXCELLENT</option>
                                <option value="AVERAGE">AVERAGE</option>
                                <option value="ACCEPTABLE">ACCEPTABLE</option>
                            </select>
                            <span class="form-error" id="bookConditionError"></span>
                        </div>
                        <div class="mb-3">
                            <label for="bookPrice" class="form-label">Price (R) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="bookPrice"
                                   placeholder="Enter price" min="0" step="0.01" required>
                            <span class="form-error" id="bookPriceError"></span>
                        </div>
                        <div class="mb-3">
                            <label for="bookDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="bookDescription" rows="3"
                                      placeholder="Describe your book (edition, highlights, etc.)"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="bookImage" class="form-label">Book Image (Max 5MB)</label>
                            <input class="form-control" type="file" id="bookImage" accept="image/*">
                            <div class="form-text">JPEG or PNG only</div>
                            <span class="form-error" id="bookImageError"></span>
                        </div>

                        <!-- Alert container -->
                        <div id="formAlertContainer"></div>
                        
                        <button type="submit" class="btn btn-purple px-4 py-2 fw-bold mt-3" id="submitButton">
                            <span id="submitText">Submit Listing</span>
                            <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Footer -->
<footer class="footer-section bg-dark text-light pt-5 pb-3 mt-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-4 mb-4 mb-md-0">
                <div class="d-flex align-items-center mb-3">
                    <img src="../assets/images/logo.png" alt="Booklify Logo" height="40" class="me-2">
                    <span class="brand-text fs-4">Booklify</span>
                </div>
                <p>Your trusted platform for affordable textbooks. Connecting students and educators with quality books at unbeatable prices.</p>
                <div class="d-flex gap-2">
                    <a href="#" class="footer-social"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="footer-social"><i class="bi bi-twitter"></i></a>
                    <a href="#" class="footer-social"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="footer-social"><i class="bi bi-linkedin"></i></a>
                </div>
            </div>
            <div class="col-md-2 mb-4 mb-md-0">
                <h6 class="fw-bold text-warning">Quick Links</h6>
                <ul class="list-unstyled">
                    <li><a href="../index.html" class="footer-link">Home</a></li>
                    <li><a href="products.html" class="footer-link">Buy Textbooks</a></li>
                    <li><a href="sell.html" class="footer-link">Sell Textbooks</a></li>
                    <li><a href="about.html" class="footer-link">About Us</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-4 mb-md-0">
                <h6 class="fw-bold text-warning">Support</h6>
                <ul class="list-unstyled">
                    <li><a href="#" class="footer-link">Contact Us</a></li>
                    <li><a href="#" class="footer-link">Help Center</a></li>
                    <li><a href="#" class="footer-link">Terms & Conditions</a></li>
                    <li><a href="#" class="footer-link">Privacy Policy</a></li>
                    <li><a href="#" class="footer-link">Product Details</a></li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="fw-bold text-warning">Contact Info</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-envelope"></i> Email<br><a href="mailto:support@booklify.com" class="footer-link">support@booklify.com</a></li>
                    <li class="mt-2"><i class="bi bi-telephone"></i> Phone<br><a href="tel:021 321 5432" class="footer-link">021 321 5432</a></li>
                    <li class="mt-2"><i class="bi bi-clock"></i> Support Hours<br>24/7 Available</li>
                </ul>
            </div>
        </div>
        <div class="row border-top pt-3 mt-3 small">
            <div class="col-md-8">
                <span>&copy; 2025 Booklify. All rights reserved. Empowering students with affordable education.</span>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="#" class="footer-link me-3">Terms</a>
                <a href="#" class="footer-link me-3">Privacy</a>
                <a href="#" class="footer-link">Contact</a>
            </div>
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script src="../js/navbar.js"></script>
<script>
// sell.js - This should be placed in your ../js/ directory
document.addEventListener('DOMContentLoaded', function() {
    const sellForm = document.getElementById('sellForm');
    const submitButton = document.getElementById('submitButton');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const formAlertContainer = document.getElementById('formAlertContainer');

    sellForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading state
        submitText.textContent = 'Processing...';
        submitSpinner.classList.remove('d-none');
        submitButton.disabled = true;

        try {
            // Validate form
            if (!validateForm()) {
                return;
            }

            // Prepare book data
            const book = {
                title: document.getElementById('bookTitle').value.trim(),
                author: document.getElementById('bookAuthor').value.trim(),
                publisher: document.getElementById('bookPublisher').value.trim(),
                isbn: document.getElementById('bookISBN').value.trim(),
                condition: document.getElementById('bookCondition').value,
                price: parseFloat(document.getElementById('bookPrice').value),
                description: document.getElementById('bookDescription').value.trim(),
                uploadedDate: new Date().toISOString(),
                userId: Number(localStorage.getItem('booklifyUserId')) // Add userId here
            };
            
            // Get image file
            const imageFile = document.getElementById('bookImage').files[0];

            // Create FormData to send both JSON and file
            const formData = new FormData();
            formData.append('bookRequest', new Blob([JSON.stringify(book)], {
                type: 'application/json'
            }));
            
            if (imageFile) {
                // Validate image size (max 5MB)
                if (imageFile.size > 5 * 1024 * 1024) {
                    throw new Error('Image size exceeds 5MB limit');
                }
                formData.append('imageFile', imageFile);
            }

            // Send to backend
            const response = await fetch('http://localhost:8081/api/book/create', {
                method: 'POST',
                body: formData
                // Don't set Content-Type header - let browser set it with boundary
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to create book');
            }
            const result = await response.json();
            showSuccessMessage('Book successfully listed!');
            sellForm.reset();
            
        } catch (error) {
            console.error('Error:', error);
            showErrorMessage(error.message || 'Error submitting book');
        } finally {
            // Reset button state
            submitText.textContent = 'Submit Listing';
            submitSpinner.classList.add('d-none');
            submitButton.disabled = false;
        }
    });

    function validateForm() {
        const requiredFields = [
            {id: 'bookTitle', name: 'Book Title'},
            {id: 'bookAuthor', name: 'Author'},
            {id: 'bookCondition', name: 'Condition'},
            {id: 'bookPrice', name: 'Price'}
        ];
        
        let isValid = true;
        
        // Clear previous error messages
        clearErrorMessages();
        
        requiredFields.forEach(field => {
            const fieldElement = document.getElementById(field.id);
            const errorElement = document.getElementById(field.id + 'Error');
            
            if (!fieldElement.value.trim()) {
                fieldElement.classList.add('is-invalid');
                errorElement.textContent = `${field.name} is required`;
                isValid = false;
            } else {
                fieldElement.classList.remove('is-invalid');
                errorElement.textContent = '';
            }
        });

        // Validate price is positive number
        const priceField = document.getElementById('bookPrice');
        const priceError = document.getElementById('bookPriceError');
        if (priceField.value && parseFloat(priceField.value) <= 0) {
            priceField.classList.add('is-invalid');
            priceError.textContent = 'Price must be greater than 0';
            isValid = false;
        }

        // Validate image file type if provided
        const imageField = document.getElementById('bookImage');
        const imageError = document.getElementById('bookImageError');
        if (imageField.files.length > 0) {
            const file = imageField.files[0];
            const validTypes = ['image/jpeg', 'image/png'];
            
            if (!validTypes.includes(file.type)) {
                imageField.classList.add('is-invalid');
                imageError.textContent = 'Only JPEG and PNG images are allowed';
                isValid = false;
            }
        }

        return isValid;
    }

    function clearErrorMessages() {
        const errorElements = document.querySelectorAll('.form-error');
        errorElements.forEach(element => {
            element.textContent = '';
        });
        
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => {
            field.classList.remove('is-invalid');
        });
    }

    function showSuccessMessage(message) {
        // Create success alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'lilac-alert success';
        alertDiv.innerHTML = `
            <span>${message}</span>
            <button type="button" class="alert-close">&times;</button>
        `;
        
        // Insert before the submit button
        formAlertContainer.innerHTML = '';
        formAlertContainer.appendChild(alertDiv);
        
        // Add event listener to close button
        alertDiv.querySelector('.alert-close').addEventListener('click', function() {
            alertDiv.remove();
        });
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function showErrorMessage(message) {
        // Create error alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'lilac-alert error';
        alertDiv.innerHTML = `
            <span>${message}</span>
            <button type="button" class="alert-close">&times;</button>
        `;
        
        // Insert before the submit button
        formAlertContainer.innerHTML = '';
        formAlertContainer.appendChild(alertDiv);
        
        // Add event listener to close button
        alertDiv.querySelector('.alert-close').addEventListener('click', function() {
            alertDiv.remove();
        });
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Add real-time validation for required fields
    const requiredFields = ['bookTitle', 'bookAuthor', 'bookCondition', 'bookPrice'];
    requiredFields.forEach(fieldId => {
        document.getElementById(fieldId).addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
                document.getElementById(fieldId + 'Error').textContent = '';
            }
        });
    });

    // Add real-time validation for image field
    document.getElementById('bookImage').addEventListener('change', function() {
        const imageError = document.getElementById('bookImageError');
        if (this.files.length > 0) {
            const file = this.files[0];
            const validTypes = ['image/jpeg', 'image/png'];
            
            if (!validTypes.includes(file.type)) {
                this.classList.add('is-invalid');
                imageError.textContent = 'Only JPEG and PNG images are allowed';
            } else {
                this.classList.remove('is-invalid');
                imageError.textContent = '';
            }
        } else {
            this.classList.remove('is-invalid');
            imageError.textContent = '';
        }
    });
});
</script>

<!-- Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="bookToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="bookToastMessage">
                Book successfully listed!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

</body>
</html>