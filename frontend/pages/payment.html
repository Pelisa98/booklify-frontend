<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment | Booklify</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/frontend/assets/icons/booklify.ico">
</head>
<body>
<!-- Header / Navbar (dynamically generated by navbar.js) -->
<!-- Payment Section -->
<section class="payment-section py-5 bg-light-purple min-vh-100">
    <div class="container">
        <h2 class="fw-bold text-center mb-5">Payment Details</h2>
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="bg-white rounded shadow p-4">
                    <form id="dummyPaymentForm">
                        <div class="mb-3">
                            <label for="paymentType" class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentType" required>
                                <option value="card">Credit/Debit Card</option>
                                <option value="eft">EFT</option>
                            </select>
                        </div>
                        <div id="cardFields">
                            <div class="mb-3">
                                <label for="cardNumber" class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumber" maxlength="19" placeholder="1234 5678 9012 3456" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cardExpiry" class="form-label">Expiry Date</label>
                                    <input type="text" class="form-control" id="cardExpiry" maxlength="5" placeholder="MM/YY" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cardCVC" class="form-label">CVC</label>
                                    <input type="text" class="form-control" id="cardCVC" maxlength="4" placeholder="CVC" required>
                                </div>
                            </div>
                        </div>
                        <div id="eftFields" style="display:none;">
                            <div class="mb-3">
                                <label for="bankName" class="form-label">Bank Name</label>
                                <input type="text" class="form-control" id="bankName" placeholder="Bank Name">
                            </div>
                            <div class="mb-3">
                                <label for="accountNumber" class="form-label">Account Number</label>
                                <input type="text" class="form-control" id="accountNumber" placeholder="Account Number">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-purple w-100 fw-bold" id="processPaymentBtn">Process Payment</button>
                    </form>
                    <div class="d-flex justify-content-center mt-3" id="loadingSpinner" style="display:none;">
                        <div class="spinner-border text-primary" role="status" id="spinnerIcon" style="display:none;">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <span id="processingMsg" style="display:none; margin-left: 16px; font-weight: 500; color: #4f8cff;">Payment is being processed...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Load toast helper
        (function loadToast(){
            const s = document.createElement('script');
            s.src = '../js/toastHelper.js';
            s.defer = true;
            document.head.appendChild(s);
        })();

        document.addEventListener('DOMContentLoaded', function() {
            const paymentType = document.getElementById('paymentType');
            const cardFields = document.getElementById('cardFields');
            const eftFields = document.getElementById('eftFields');
            const form = document.getElementById('dummyPaymentForm');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const processBtn = document.getElementById('processPaymentBtn');

            paymentType.addEventListener('change', function() {
                if (paymentType.value === 'card') {
                    cardFields.style.display = '';
                    eftFields.style.display = 'none';
                    cardFields.querySelectorAll('input').forEach(i => i.required = true);
                    eftFields.querySelectorAll('input').forEach(i => i.required = false);
                } else {
                    cardFields.style.display = 'none';
                    eftFields.style.display = '';
                    cardFields.querySelectorAll('input').forEach(i => i.required = false);
                    eftFields.querySelectorAll('input').forEach(i => i.required = true);
                }
            });

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                processBtn.disabled = true;
                loadingSpinner.style.display = 'flex';
                spinnerIcon.style.display = 'inline-block';
                processingMsg.style.display = 'block';

                setTimeout(async () => {
                    try {
                        const userId = localStorage.getItem('booklifyUserId');
                        const paymentMethod = localStorage.getItem('booklifyPaymentMethod') || (paymentType.value === 'card' ? 'CARD' : 'EFT');
                        // Fetch address for user (should exist from checkout)
                        const addressRes = await fetch(`http://localhost:8081/api/addresses/user/${userId}`);
                        if (!addressRes.ok) {
                            const t = await addressRes.text();
                            console.error('Address fetch failed:', addressRes.status, t);
                            throw new Error(`Address lookup failed: ${addressRes.status} ${addressRes.statusText} - ${t}`);
                        }
                        const address = await addressRes.json();
                        const addressId = address.id;
                        // Fetch cart
                        const cartRes = await fetch(`http://localhost:8081/api/cart/getByUserId/${userId}`);
                        if (!cartRes.ok) {
                            const t = await cartRes.text();
                            console.error('Cart fetch failed:', cartRes.status, t);
                            throw new Error(`Cart lookup failed: ${cartRes.status} ${cartRes.statusText} - ${t}`);
                        }
                        const cart = await cartRes.json();
                        // Build order items
                        const orderItems = (cart.cartItems || []).map(item => ({
                            bookId: item.book.bookID,
                            quantity: item.quantity,
                            orderStatus: 'PENDING'
                        }));

                        // Pre-check availability and auto-adjust cart if shortages found
                        async function preCheckAndAdjust(orderItems, cart) {
                            const shortages = [];
                            // fetch latest book data in parallel
                            const fetches = orderItems.map(i => fetch(`http://localhost:8081/api/book/read/${i.bookId}`).then(r => ({ r, i })).catch(e => ({ err: e, i })));
                            const results = await Promise.all(fetches);
                            for (const resObj of results) {
                                const i = resObj.i;
                                if (resObj.err) {
                                    shortages.push({ bookId: i.bookId, required: i.quantity, available: 0, reason: 'Fetch error' });
                                    continue;
                                }
                                const r = resObj.r;
                                if (!r.ok) {
                                    const t = await r.text().catch(()=>'');
                                    shortages.push({ bookId: i.bookId, required: i.quantity, available: 0, reason: `Fetch failed: ${r.status} ${t}` });
                                    continue;
                                }
                                const book = await r.json();
                                const available = (typeof book.available === 'number') ? book.available : 0;
                                if (available < i.quantity) {
                                    shortages.push({ bookId: i.bookId, required: i.quantity, available, reason: 'Insufficient stock' });
                                }
                            }

                            if (shortages.length === 0) return [];

                            // Auto-adjust cart: set quantities to available for affected items
                            for (const s of shortages) {
                                try {
                                    // Update via CartService endpoint
                                    await fetch(`http://localhost:8081/api/cart/updateCartItemsQuantity/${cart.cartId}/${s.bookId}/${s.available}`, { method: 'PUT' });
                                } catch (err) {
                                    console.warn('Failed to auto-adjust cart for book', s.bookId, err);
                                }
                            }

                            return shortages;
                        }

                        const shortages = await preCheckAndAdjust(orderItems, cart);
                        if (shortages.length) {
                            const msg = shortages.map(s => `Book id ${s.bookId}: required ${s.required}, available ${s.available} ${s.reason? '('+s.reason+')':''}`).join('\n');
                            if (window.showToast) {
                                window.showToast('Some items were adjusted due to low stock. Check your cart.', 'warning', 6000);
                            } else {
                                alert('Some items were adjusted due to low stock. Check your cart.');
                            }
                            // Redirect user back to cart to review changes
                            setTimeout(() => window.location.href = 'cart.html', 800);
                            return;
                        }
                        // Create order
                        const orderRes = await fetch('http://localhost:8081/api/orders/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                regularUserId: userId,
                                shippingAddressId: addressId,
                                orderItems
                            })
                        });
                        if (!orderRes.ok) {
                            const t = await orderRes.text();
                            console.error('Order creation failed:', orderRes.status, t);
                            throw new Error(`Order creation failed: ${orderRes.status} ${orderRes.statusText} - ${t}`);
                        }
                        const order = await orderRes.json();
                        // Create payment
                        const paymentRes = await fetch('http://localhost:8081/api/payments/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId,
                                orderId: order.orderId,
                                paymentMethod
                            })
                        });
                        if (!paymentRes.ok) {
                            const t = await paymentRes.text();
                            console.error('Payment creation failed:', paymentRes.status, t);
                            throw new Error(`Payment failed: ${paymentRes.status} ${paymentRes.statusText} - ${t}`);
                        }
                        // Optionally clear cart (delete or empty)
                        const clearRes = await fetch(`http://localhost:8081/api/cart/clear/${cart.cartId}`, { method: 'DELETE' });
                        if (!clearRes.ok) {
                            const t = await clearRes.text();
                            console.warn('Clearing cart returned non-ok:', clearRes.status, t);
                        }
                        loadingSpinner.style.display = 'none';
                        document.getElementById('processingMsg').style.display = 'none';
                        processBtn.disabled = false;
                        alert('Payment successful! Thank you for your purchase.');
                        window.location.href = 'products.html';
                    } finally {
                        spinnerIcon.style.display = 'none';
                        processingMsg.style.display = 'none';
                        loadingSpinner.style.display = 'none';
                        processBtn.disabled = false;
                    }
                }, 2000).catch(err => {
                    // Extra safety: catch promise rejections from the setTimeout handler
                    console.error('Payment submission error:', err);
                    alert('Payment failed: ' + (err && err.message ? err.message : String(err)));
                    spinnerIcon.style.display = 'none';
                    processingMsg.style.display = 'none';
                    loadingSpinner.style.display = 'none';
                    processBtn.disabled = false;
                });
            });
        });
    </script>
</section>

    <script src="../js/navbar.js"></script>
    <script type="module" src="../js/payment.js"></script>
</body>
</html>